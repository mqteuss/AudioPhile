<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Spobrefy</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #e5e5e5;
        }

        #app-background {
            position: fixed;
            top: -10px; left: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            background-size: cover;
            background-position: center;
            filter: blur(20px) brightness(0.4);
            transition: background-image 0.7s ease-in-out;
            z-index: -1;
        }

        #progress-bar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            cursor: pointer;
            outline: none;
            border-radius: 15px;
            height: 18px; 
            background: transparent;
        }

        #progress-bar::-webkit-slider-runnable-track {
            height: 4px;
            background: linear-gradient(to right, #1DB954 var(--progress-percent, 0%), rgba(255, 255, 255, 0.2) var(--progress-percent, 0%));
            border-radius: 15px;
            transition: height 0.2s ease-in-out;
        }
        #progress-bar::-moz-range-track {
            height: 4px;
            background: linear-gradient(to right, #1DB954 var(--progress-percent, 0%), rgba(255, 255, 255, 0.2) var(--progress-percent, 0%));
            border-radius: 15px;
            transition: height 0.2s ease-in-out;
        }

        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #e5e5e5;
            border-radius: 50%;
            border: none;
            margin-top: -6px; 
            transition: transform 0.2s ease-in-out, background 0.2s ease-in-out;
            transform: scale(0); 
        }
         #progress-bar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #e5e5e5;
            border-radius: 50%;
            border: none;
            transition: transform 0.2s ease-in-out, background 0.2s ease-in-out;
            transform: scale(0);
        }

        .progress-container:hover #progress-bar::-webkit-slider-runnable-track,
        .progress-container:hover #progress-bar::-moz-range-track {
            height: 6px;
        }
        .progress-container:hover #progress-bar::-webkit-slider-thumb,
        .progress-container:hover #progress-bar::-moz-range-thumb {
            transform: scale(1);
        }
         .progress-container:hover #progress-bar::-webkit-slider-thumb {
            margin-top: -5px; 
        }

        #progress-bar:active::-webkit-slider-thumb,
        #progress-bar:focus::-webkit-slider-thumb,
        #progress-bar:active::-moz-range-thumb,
        #progress-bar:focus::-moz-range-thumb {
             background: #1DB954;
        }

        .view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
        .view:not(.active) {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
        }

        .repeat-mode-one::after {
            content: '1';
            position: absolute;
            top: -2px; right: -4px;
            font-size: 9px;
            font-weight: bold;
            background-color: #1DB954;
            color: #121212;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            line-height: 12px;
            text-align: center;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }

        @keyframes toast-in {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .toast-in { animation: toast-in 0.4s ease-in-out forwards; }
        .toast-out { animation: toast-out 0.4s ease-in-out forwards; }

        @keyframes nav-icon-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.85); }
            100% { transform: scale(1); }
        }
        .nav-icon-bounce { animation: nav-icon-bounce 0.3s ease-in-out; }

        #playlist-song-list { counter-reset: song-counter; }
        #playlist-song-list .song-item .song-number-container {
            position: absolute; top: 0; left: 0; width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: #a1a1aa; transition: opacity 0.2s ease-in-out;
        }
        #playlist-song-list .song-item .song-number-container::before {
            counter-increment: song-counter; content: counter(song-counter);
        }
        #playlist-song-list .song-item .song-cover { transition: opacity 0.2s ease-in-out; opacity: 1; }
        #playlist-song-list .song-item .clickable-area:hover .song-cover { opacity: 0.2; }
        #playlist-song-list .song-item .song-number-container { opacity: 0; }
        #playlist-song-list .song-item .clickable-area:hover .song-number-container { opacity: 1; }

        .song-item.playing .song-title { color: #1DB954; }
    </style>
</head>
<body class="bg-black antialiased overflow-hidden" style="padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);">

    <div id="app-background"></div>
    <input type="file" id="music-folder-input" webkitdirectory directory multiple class="hidden">

    <main id="app-content" class="h-screen w-screen relative">
        <div id="player-view" class="view active flex flex-col justify-start items-center p-6 pt-10 md:pt-12">
            <div class="w-full max-w-sm">
                <img id="album-cover" src="https://placehold.co/500x500/101010/1DB954?text=Spobrefy" alt="Capa do Álbum" class="w-full aspect-square rounded-lg shadow-2xl object-cover">
                <div class="flex justify-between items-center my-8 gap-4">
                    <div class="flex-grow min-w-0">
                        <h2 id="track-title" class="text-2xl font-bold truncate text-left">Bem-vindo!</h2>
                        <h3 id="track-artist" class="text-md text-zinc-400 truncate text-left">Sincronize ou adicione suas músicas</h3>
                    </div>
                    <button id="add-to-playlist-from-player-btn" class="control-btn p-2 w-12 h-12 flex-shrink-0 flex items-center justify-center text-zinc-400 hover:text-white transition-colors" title="Adicionar à playlist">
                        <i class="fas fa-plus text-xl"></i>
                    </button>
                </div>
                <div>
                     <div class="progress-container mb-2">
                         <input type="range" id="progress-bar" class="w-full appearance-none cursor-pointer" value="0" step="1">
                         <div class="flex justify-between text-xs text-zinc-400 mt-1.5">
                             <span id="current-time">0:00</span>
                             <span id="duration">0:00</span>
                         </div>
                     </div>
                     <div class="flex justify-between items-center text-zinc-200 px-2 my-6">
                         <button id="shuffle-btn" class="control-btn p-2 w-12 h-12 flex items-center justify-center transition-colors relative" title="Aleatório"><i class="fas fa-shuffle text-xl"></i></button>
                         <button id="prev-btn" class="control-btn p-2 transition-colors" title="Anterior"><i class="fas fa-backward-step text-4xl"></i></button>
                         <button id="play-pause-btn" class="control-btn bg-white text-black rounded-full w-20 h-20 flex items-center justify-center hover:scale-105 transition-transform shadow-lg" title="Play/Pause"><i class="fas fa-play text-3xl ml-1"></i></button>
                         <button id="next-btn" class="control-btn p-2 transition-colors" title="Próxima"><i class="fas fa-forward-step text-4xl"></i></button>
                         <button id="repeat-btn" class="control-btn p-2 w-12 h-12 flex items-center justify-center transition-colors relative" title="Repetir"><i class="fas fa-repeat text-xl"></i></button>
                     </div>
                </div>
            </div>
        </div>

        <div id="search-view" class="view pb-20 flex flex-col">
            <h1 class="text-3xl font-bold px-6 md:px-8 pt-6 md:pt-8 mb-4 flex-shrink-0">Catálogo</h1>
            <div class="sticky top-0 z-10 px-6 md:px-8 py-3 flex-shrink-0" style="padding-top: calc(0.75rem + env(safe-area-inset-top));">
                <div class="flex items-center gap-3">
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="O que você quer ouvir?" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 pl-10 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                    </div>
                    <button id="add-music-btn" title="Adicionar Pasta de Músicas" class="flex-shrink-0 text-zinc-400 hover:text-white bg-zinc-800 hover:bg-zinc-700 transition-colors w-10 h-10 flex items-center justify-center rounded-lg">
                        <i class="fas fa-folder-plus text-xl"></i>
                    </button>
                    <button id="sync-btn" title="Sincronizar Catálogo" class="flex-shrink-0 text-zinc-400 hover:text-white bg-zinc-800 hover:bg-zinc-700 transition-colors w-10 h-10 flex items-center justify-center rounded-lg disabled:opacity-50 disabled:cursor-wait">
                        <i class="fas fa-sync text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="px-6 md:px-8 flex-grow relative">
                <div id="library-empty-state" class="text-center text-zinc-500 mt-16 absolute inset-0 flex flex-col items-center justify-center">
                    <i id="library-empty-icon" class="fas fa-music text-5xl mb-4"></i>
                    <h3 id="library-empty-title" class="text-xl font-semibold text-white mb-2">Sua biblioteca está vazia</h3>
                    <p id="library-empty-text">Use o botão <i class="fas fa-folder-plus"></i> para começar.</p>
                </div>
                <div id="song-list" class="mt-4 h-full"></div>
            </div>
        </div>

        <div id="playlists-view" class="view p-6 md:p-8 pb-20">
             <h1 class="text-3xl font-bold mb-6">Suas Playlists</h1>
               <div id="playlist-grid" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="playlist-details-view" class="view p-6 md:p-8 pb-20 flex flex-col">
            <div class="flex items-center mb-4 flex-shrink-0">
                <button id="back-to-playlists-btn" class="p-2 mr-2 flex-shrink-0"><i class="fas fa-arrow-left text-xl"></i></button>
            </div>
            <div class="text-center px-4 flex-shrink-0">
                <div id="playlist-details-cover" class="w-48 h-48 mx-auto rounded-lg bg-zinc-800 flex items-center justify-center shadow-lg mb-4 overflow-hidden">
                    <img id="playlist-details-cover-img" src="" alt="Capa da Playlist" class="w-full h-full object-cover hidden" loading="lazy">
                    <i id="playlist-details-cover-icon" class="fas fa-music text-6xl text-zinc-600"></i>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <h1 id="playlist-details-title" class="text-3xl font-bold truncate">Nome da Playlist</h1>
                    <button id="edit-playlist-title-btn" class="text-zinc-500 hover:text-white" title="Renomear playlist"><i class="fas fa-pencil"></i></button>
                </div>
                <p id="playlist-details-meta" class="text-zinc-400 text-sm mt-1"></p>
                <div class="flex justify-center items-center gap-4 my-6">
                    <button id="playlist-play-btn" class="bg-green-500 text-black font-bold py-3 px-6 rounded-full hover:scale-105 transition-transform text-lg">Play</button>
                    <button id="playlist-shuffle-btn" class="border border-zinc-600 text-white font-bold py-3 px-6 rounded-full hover:bg-zinc-700 transition-colors text-lg">Shuffle</button>
                    <button id="playlist-download-all-btn" class="border border-zinc-600 text-zinc-300 w-12 h-12 rounded-full hover:bg-zinc-700 transition-colors flex items-center justify-center" title="Baixar todas as músicas da playlist">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
             </div>
             <div class="flex-grow relative mt-4">
                <div id="playlist-empty-state" class="text-center text-zinc-500 mt-10 hidden absolute inset-0 flex flex-col items-center justify-center">
                    <i class="fas fa-compact-disc text-5xl mb-4"></i>
                    <h3 class="text-xl font-semibold text-white mb-2">Esta playlist está vazia</h3>
                    <p>Adicione músicas do seu catálogo para começar.</p>
                </div>
                <div id="playlist-song-list" class="h-full"></div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-[64px] bg-zinc-900/50 backdrop-blur-lg flex justify-around items-center border-t border-zinc-800">
        <button data-view="search-view" class="nav-btn flex flex-col items-center justify-center w-full h-full gap-1 text-zinc-400 transition-colors"><i class="fas fa-search text-xl"></i><span class="text-xs">Catálogo</span></button>
        <button data-view="player-view" class="nav-btn flex flex-col items-center justify-center w-full h-full gap-1 text-green-500 transition-colors"><i class="fas fa-circle-play text-xl"></i><span class="text-xs">Player</span></button>
        <button data-view="playlists-view" class="nav-btn flex flex-col items-center justify-center w-full h-full gap-1 text-zinc-400 transition-colors"><i class="fas fa-bars-staggered text-xl"></i><span class="text-xs">Playlists</span></button>
        <button id="create-playlist-btn" class="nav-btn flex flex-col items-center justify-center w-full h-full gap-1 text-zinc-400 transition-colors"><i class="fas fa-plus text-xl"></i><span class="text-xs">Criar</span></button>
    </nav>

    <div id="create-playlist-modal" class="modal-overlay fixed inset-0 bg-black/70 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-sm bg-zinc-800 rounded-xl p-6 shadow-2xl transform scale-95">
             <h2 id="playlist-modal-title" class="text-xl font-bold text-center mb-4">Criar nova playlist</h2>
             <input id="playlist-name-input" type="text" placeholder="Dê um nome à sua playlist" class="w-full bg-zinc-700 border-zinc-600 rounded-lg px-4 py-3 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-green-500 mb-6">
             <div class="flex justify-end gap-3">
                 <button id="cancel-playlist-btn" class="px-5 py-2 rounded-full font-semibold transition-colors hover:bg-zinc-700">Cancelar</button>
                 <button id="confirm-playlist-btn" class="bg-green-500 text-black px-5 py-2 rounded-full font-semibold transition-colors hover:bg-green-400">Criar</button>
             </div>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="modal-overlay fixed inset-0 bg-black/70 flex justify-center items-end sm:items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-sm bg-zinc-800 rounded-xl p-2 shadow-2xl transform translate-y-full sm:translate-y-0 sm:scale-95">
             <h2 class="text-xl font-bold text-center p-4">Adicionar à playlist</h2>
             <div id="playlist-selection-list" class="max-h-60 overflow-y-auto"></div>
             <button id="add-to-playlist-cancel-btn" class="w-full p-4 mt-2 font-semibold hover:bg-zinc-700 rounded-lg">Cancelar</button>
        </div>
    </div>

    <div id="song-options-modal" class="modal-overlay fixed inset-0 bg-black/70 flex justify-center items-end sm:items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-sm bg-zinc-800 rounded-xl p-2 shadow-2xl transform translate-y-full sm:translate-y-0 sm:scale-95">
            <div class="p-4 border-b border-zinc-700">
                <p id="options-modal-title" class="font-bold text-center truncate">Nome da Música</p>
                <p id="options-modal-artist" class="text-sm text-zinc-400 text-center truncate">Artista</p>
            </div>
            <ul class="text-center">
                <li id="options-add-to-playlist-li"><button id="options-add-to-playlist-btn" class="w-full text-left p-4 hover:bg-zinc-700 rounded-lg">Adicionar à playlist</button></li>
                <li id="options-remove-from-playlist-li"><button id="options-remove-from-playlist-btn" class="w-full text-left p-4 hover:bg-zinc-700 rounded-lg text-red-500">Remover da playlist</button></li>
                <li><button id="options-download-btn" class="w-full text-left p-4 hover:bg-zinc-700 rounded-lg">Baixar</button></li>
            </ul>
             <button id="options-cancel-btn" class="w-full p-4 mt-2 font-semibold hover:bg-zinc-700 rounded-lg">Cancelar</button>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black/70 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-sm bg-zinc-800 rounded-xl p-6 shadow-2xl transform scale-95">
             <p id="confirmation-modal-text" class="text-center mb-6"></p>
             <div class="flex justify-end gap-3">
                 <button id="confirmation-cancel-btn" class="px-5 py-2 rounded-full font-semibold transition-colors hover:bg-zinc-700">Cancelar</button>
                 <button id="confirmation-ok-btn" class="bg-red-500 text-white px-5 py-2 rounded-full font-semibold transition-colors hover:bg-red-400">OK</button>
             </div>
        </div>
    </div>

    <div id="notification-modal" class="modal-overlay fixed inset-0 bg-black/70 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-sm bg-zinc-800 rounded-xl p-6 shadow-2xl transform scale-95">
             <p id="notification-modal-text" class="text-center mb-6"></p>
             <div class="flex justify-end">
                 <button id="notification-ok-btn" class="bg-green-500 text-black px-5 py-2 rounded-full font-semibold transition-colors hover:bg-green-400">OK</button>
             </div>
        </div>
    </div>

    <template id="song-item-template">
        <li class="song-item group flex items-center gap-3 p-3 rounded-lg hover:bg-zinc-800/80 transition-colors">
            <div class="clickable-area flex-grow min-w-0 flex items-center gap-3 cursor-pointer">
                <div class="relative w-12 h-12 flex-shrink-0">
                    <div class="song-number-container"></div>
                    <img class="song-cover w-full h-full rounded-md object-cover" src="https://placehold.co/100x100/27272a/3f3f46?text=?" alt="Capa" loading="lazy">
                </div>
                <div class="flex-grow min-w-0">
                    <p class="song-title font-semibold truncate"></p>
                    <p class="song-artist text-sm text-zinc-400 truncate"></p>
                </div>
            </div>
            <i class="offline-indicator fas fa-check-circle text-green-500 hidden mr-2" title="Disponível offline"></i>
            <button class="options-btn text-zinc-400 hover:text-white p-2 rounded-full hover:bg-zinc-700" title="Mais opções">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </li>
    </template>

    <template id="playlist-item-template">
        <div class="playlist-item-grid-entry group flex items-center justify-between gap-4 p-3 rounded-lg bg-zinc-900/50 hover:bg-zinc-800/80 transition-colors">
            <div class="playlist-clickable-area flex-grow flex items-center gap-4 cursor-pointer">
                <img class="playlist-cover w-16 h-16 rounded-md object-cover" src="https://placehold.co/100x100/101010/1DB954?text=PLAY" alt="Capa da Playlist" loading="lazy">
                <div>
                    <p class="playlist-name font-semibold"></p>
                    <p class="playlist-song-count text-sm text-zinc-400"></p>
                </div>
            </div>
            <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="edit-playlist-btn text-zinc-500 hover:text-white p-2" title="Renomear playlist"><i class="fas fa-pencil"></i></button>
                <button class="delete-playlist-btn text-zinc-500 hover:text-red-500 p-2" title="Excluir playlist"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </template>

    <div id="toast-container" class="fixed bottom-20 sm:bottom-4 right-4 z-50 flex flex-col items-end gap-3"></div>

<script>
    const VirtualScroller = {
        instances: new Map(),
        create(containerId, options = {}) {
            const config = {
                itemHeight: options.itemHeight || 64,
                buffer: options.buffer || 5,
                renderItem: options.renderItem || (() => {}),
                data: options.data || [],
                container: document.getElementById(containerId),
            };
            if (!config.container) return null;
            const instance = {
                config, viewport: null, content: null, visibleItems: new Map(),
                scrollTop: 0, startIndex: 0, endIndex: 0,
                init() { this.setupDOM(); this.update(); this.bindEvents(); },
                setupDOM() {
                    this.config.container.innerHTML = '';
                    this.config.container.style.cssText = 'position: relative; overflow: auto; height: 100%;';
                    this.viewport = document.createElement('div');
                    this.viewport.style.cssText = 'position: relative; width: 100%;';
                    this.viewport.style.height = `${this.config.data.length * this.config.itemHeight}px`;
                    this.content = document.createElement('div');
                    this.content.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%;';
                    this.viewport.appendChild(this.content);
                    this.config.container.appendChild(this.viewport);
                },
                bindEvents() { this.config.container.addEventListener('scroll', () => { this.scrollTop = this.config.container.scrollTop; requestAnimationFrame(() => this.update()); }); },
                update() {
                    const { itemHeight, buffer, data } = this.config;
                    const containerHeight = this.config.container.clientHeight;
                    this.startIndex = Math.max(0, Math.floor(this.scrollTop / itemHeight) - buffer);
                    this.endIndex = Math.min(data.length - 1, Math.ceil((this.scrollTop + containerHeight) / itemHeight) + buffer);
                    this.render();
                },
                render() {
                    const { data, itemHeight } = this.config;
                    const newVisibleItems = new Map();
                    for (const [index, element] of this.visibleItems) {
                        if (index < this.startIndex || index > this.endIndex) {
                            element.remove();
                            App.cleanupItemURLs(element);
                        } else {
                            newVisibleItems.set(index, element);
                        }
                    }
                    for (let i = this.startIndex; i <= this.endIndex; i++) {
                        if (!newVisibleItems.has(i)) {
                            const element = this.config.renderItem(data[i], i);
                            element.style.cssText = `position: absolute; width: 100%; height: ${itemHeight}px; top: ${i * itemHeight}px;`;
                            this.content.appendChild(element);
                            newVisibleItems.set(i, element);
                        }
                    }
                    this.visibleItems = newVisibleItems;
                },
                setData(newData) {
                    this.config.data = newData;
                    this.viewport.style.height = `${newData.length * this.config.itemHeight}px`;
                    this.visibleItems.forEach(el => { App.cleanupItemURLs(el); el.remove(); });
                    this.visibleItems.clear();
                    this.config.container.scrollTop = 0;
                    this.update();
                },
                destroy() {
                    this.visibleItems.forEach(el => { App.cleanupItemURLs(el); el.remove(); });
                    this.visibleItems.clear();
                    if (this.config.container) this.config.container.innerHTML = '';
                }
            };
            instance.init();
            this.instances.set(containerId, instance);
            return instance;
        },
        get(containerId) { return this.instances.get(containerId); },
        destroy(containerId) {
            const instance = this.instances.get(containerId);
            if (instance) {
                instance.destroy();
                this.instances.delete(containerId);
            }
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            dom: {
                appContent: document.getElementById('app-content'),
                background: document.getElementById('app-background'),
                albumCover: document.getElementById('album-cover'),
                trackTitle: document.getElementById('track-title'),
                trackArtist: document.getElementById('track-artist'),
                progressBar: document.getElementById('progress-bar'),
                currentTimeEl: document.getElementById('current-time'),
                durationEl: document.getElementById('duration'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                prevBtn: document.getElementById('prev-btn'),
                nextBtn: document.getElementById('next-btn'),
                shuffleBtn: document.getElementById('shuffle-btn'),
                repeatBtn: document.getElementById('repeat-btn'),
                navButtons: document.querySelectorAll('.nav-btn'),
                views: document.querySelectorAll('.view'),
                addMusicBtn: document.getElementById('add-music-btn'),
                syncBtn: document.getElementById('sync-btn'),
                musicFolderInput: document.getElementById('music-folder-input'),
                songList: document.getElementById('song-list'),
                libraryEmptyState: document.getElementById('library-empty-state'),
                libraryEmptyIcon: document.getElementById('library-empty-icon'),
                libraryEmptyTitle: document.getElementById('library-empty-title'),
                libraryEmptyText: document.getElementById('library-empty-text'),
                songItemTemplate: document.getElementById('song-item-template'),
                searchInput: document.getElementById('search-input'),
                playlistGrid: document.getElementById('playlist-grid'),
                playlistItemTemplate: document.getElementById('playlist-item-template'),
                createPlaylistBtn: document.getElementById('create-playlist-btn'),
                createPlaylistModal: document.getElementById('create-playlist-modal'),
                playlistModalTitle: document.getElementById('playlist-modal-title'),
                cancelPlaylistBtn: document.getElementById('cancel-playlist-btn'),
                confirmPlaylistBtn: document.getElementById('confirm-playlist-btn'),
                playlistNameInput: document.getElementById('playlist-name-input'),
                addToPlaylistModal: document.getElementById('add-to-playlist-modal'),
                playlistSelectionList: document.getElementById('playlist-selection-list'),
                addToPlaylistCancelBtn: document.getElementById('add-to-playlist-cancel-btn'),
                playlistDetailsView: document.getElementById('playlist-details-view'),
                backToPlaylistsBtn: document.getElementById('back-to-playlists-btn'),
                playlistDetailsTitle: document.getElementById('playlist-details-title'),
                editPlaylistTitleBtn: document.getElementById('edit-playlist-title-btn'),
                playlistDetailsMeta: document.getElementById('playlist-details-meta'),
                playlistDetailsCover: document.getElementById('playlist-details-cover'),
                playlistDetailsCoverImg: document.getElementById('playlist-details-cover-img'),
                playlistDetailsCoverIcon: document.getElementById('playlist-details-cover-icon'),
                playlistSongList: document.getElementById('playlist-song-list'),
                playlistPlayBtn: document.getElementById('playlist-play-btn'),
                playlistShuffleBtn: document.getElementById('playlist-shuffle-btn'),
                playlistDownloadAllBtn: document.getElementById('playlist-download-all-btn'),
                playlistEmptyState: document.getElementById('playlist-empty-state'),
                songOptionsModal: document.getElementById('song-options-modal'),
                optionsModalTitle: document.getElementById('options-modal-title'),
                optionsModalArtist: document.getElementById('options-modal-artist'),
                optionsAddToPlaylistBtn: document.getElementById('options-add-to-playlist-btn'),
                optionsAddToPlaylistLi: document.getElementById('options-add-to-playlist-li'),
                optionsRemoveFromPlaylistBtn: document.getElementById('options-remove-from-playlist-btn'),
                optionsRemoveFromPlaylistLi: document.getElementById('options-remove-from-playlist-li'),
                optionsDownloadBtn: document.getElementById('options-download-btn'),
                optionsCancelBtn: document.getElementById('options-cancel-btn'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmationModalText: document.getElementById('confirmation-modal-text'),
                confirmationCancelBtn: document.getElementById('confirmation-cancel-btn'),
                confirmationOkBtn: document.getElementById('confirmation-ok-btn'),
                notificationModal: document.getElementById('notification-modal'),
                notificationModalText: document.getElementById('notification-modal-text'),
                notificationOkBtn: document.getElementById('notification-ok-btn'),
                toastContainer: document.getElementById('toast-container'),
                addToPlaylistFromPlayerBtn: document.getElementById('add-to-playlist-from-player-btn'),
            },
            state: {
                songs: [], playlists: [], currentSongIndex: -1, isPlaying: false,
                isShuffle: false, repeatMode: 'none', currentPlaylistId: null, playQueue: [],
                currentQueueIndex: -1, restoredState: null, touchStartX: 0, touchEndX: 0,
                viewOrder: ['search-view', 'player-view', 'playlists-view'], currentObjectUrl: null,
                currentPlayerCoverUrl: null, debounceTimer: null, songIdForOptions: null,
                isPlaylistContextForOptions: false, confirmationCallback: null, playlistIdToEdit: null, activeToastTimeout: null, 
            },
            audio: new Audio(), imageObserver: null, CACHE_NAME: 'spobrefy-audio-cache-v1',
            async init() {
                this.virtualScrollers = { songList: null, playlistSongList: null };
                this.registerServiceWorker();
                await this.initDB();
                this.setupImageObserver();
                this.bindEvents();
                this.setupMediaSession();
                await this.loadSongsFromDB();
                await this.loadPlaylistsFromDB();
                await this.syncWithServerFolder();
                await this.loadPlaybackState();
                this.updateRepeatButtonUI();
                this.updateShuffleButtonUI();
                this.switchView('player-view');
            },
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(err => console.log(`Service Worker: Erro: ${err}`));
                }
            },
            debounce(func, delay) { return (...args) => { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => func.apply(this, args), delay); }; },
            animateIcon(element) { const icon = element.querySelector('i'); if (icon) { icon.classList.add('nav-icon-bounce'); icon.addEventListener('animationend', () => icon.classList.remove('nav-icon-bounce'), { once: true }); } },
            bindEvents() {
                this.dom.navButtons.forEach(btn => btn.dataset.view && btn.addEventListener('click', e => { this.switchView(e.currentTarget.dataset.view); this.animateIcon(e.currentTarget); }));
                this.dom.playPauseBtn.addEventListener('click', e => { this.togglePlayPause(); this.animateIcon(e.currentTarget); });
                this.dom.nextBtn.addEventListener('click', e => { this.changeTrack('next'); this.animateIcon(e.currentTarget); });
                this.dom.prevBtn.addEventListener('click', e => { this.changeTrack('prev'); this.animateIcon(e.currentTarget); });
                this.dom.repeatBtn.addEventListener('click', e => { this.toggleRepeatMode(); this.animateIcon(e.currentTarget); });
                this.dom.shuffleBtn.addEventListener('click', e => { this.toggleShuffle(); this.animateIcon(e.currentTarget); });
                this.dom.progressBar.addEventListener('input', e => this.seek(e.target.value));
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.handleSongEnd());
                this.audio.addEventListener('loadedmetadata', () => this.handleMetadataLoaded());
                this.audio.addEventListener('pause', () => this.savePlaybackState());
                this.audio.addEventListener('volumechange', () => this.savePlaybackState());
                window.addEventListener('beforeunload', () => this.savePlaybackState());
                this.dom.addMusicBtn.addEventListener('click', () => this.dom.musicFolderInput.click());
                this.dom.syncBtn.addEventListener('click', () => this.syncWithServerFolder());
                this.dom.musicFolderInput.addEventListener('change', e => this.addMusicFiles(e.target.files));
                this.dom.searchInput.addEventListener('input', this.debounce(e => this.filterSongList(e.target.value), 250));
                this.dom.createPlaylistBtn.addEventListener('click', () => this.openCreatePlaylistModal());
                this.dom.cancelPlaylistBtn.addEventListener('click', () => this.showPlaylistModal(false));
                this.dom.confirmPlaylistBtn.addEventListener('click', () => this.handlePlaylistFormSubmit());
                this.dom.createPlaylistModal.addEventListener('click', e => { if (e.target === this.dom.createPlaylistModal) this.showPlaylistModal(false); });
                this.dom.addToPlaylistModal.addEventListener('click', e => { if (e.target === this.dom.addToPlaylistModal) this.showAddToPlaylistModal(false); });
                this.dom.addToPlaylistCancelBtn.addEventListener('click', () => this.showAddToPlaylistModal(false));
                this.dom.playlistSelectionList.addEventListener('click', e => { const listItem = e.target.closest('[data-playlist-id]'); if(listItem) this.addSongToPlaylist(parseInt(listItem.dataset.playlistId)); });
                this.dom.optionsCancelBtn.addEventListener('click', () => this.showSongOptionsModal(false));
                this.dom.songOptionsModal.addEventListener('click', e => { if (e.target === this.dom.songOptionsModal) this.showSongOptionsModal(false); });
                this.dom.optionsAddToPlaylistBtn.addEventListener('click', () => { this.showAddToPlaylistModal(true); this.showSongOptionsModal(false); });
                this.dom.optionsRemoveFromPlaylistBtn.addEventListener('click', () => { this.removeSongFromPlaylist(); this.showSongOptionsModal(false); });
                this.dom.optionsDownloadBtn.addEventListener('click', () => { this.toggleSongOfflineStatus(); this.showSongOptionsModal(false); });
                this.dom.confirmationCancelBtn.addEventListener('click', () => this.showConfirmationModal(null, null, false));
                this.dom.confirmationOkBtn.addEventListener('click', () => { if (typeof this.state.confirmationCallback === 'function') this.state.confirmationCallback(); this.showConfirmationModal(null, null, false); });
                this.dom.notificationOkBtn.addEventListener('click', () => this.showNotificationModal(null, false));
                this.dom.playlistGrid.addEventListener('click', e => {
                    const entry = e.target.closest('.playlist-item-grid-entry');
                    if (!entry) return;
                    const playlistId = parseInt(entry.dataset.id);
                    if (e.target.closest('.delete-playlist-btn')) this.deletePlaylist(playlistId);
                    else if (e.target.closest('.edit-playlist-btn')) this.openRenamePlaylistModal(playlistId);
                    else if (e.target.closest('.playlist-clickable-area')) this.showPlaylistDetails(playlistId);
                });
                this.dom.backToPlaylistsBtn.addEventListener('click', () => this.switchView('playlists-view'));
                this.dom.playlistPlayBtn.addEventListener('click', () => this.playPlaylist(false));
                this.dom.playlistShuffleBtn.addEventListener('click', () => this.playPlaylist(true));
                this.dom.playlistDownloadAllBtn.addEventListener('click', () => this.downloadPlaylist());
                this.dom.editPlaylistTitleBtn.addEventListener('click', () => this.openRenamePlaylistModal(this.state.currentPlaylistId));
                this.dom.songList.addEventListener('click', e => { const scroller = VirtualScroller.get('song-list'); this.handleSongListClick(e, scroller ? scroller.config.data : this.state.songs, false); });
                this.dom.playlistSongList.addEventListener('click', e => { const scroller = VirtualScroller.get('playlist-song-list'); if (scroller) this.handleSongListClick(e, scroller.config.data, true); });
                this.dom.appContent.addEventListener('touchstart', e => this.handleTouchStart(e), false);
                this.dom.appContent.addEventListener('touchmove', e => this.handleTouchMove(e), false);
                this.dom.appContent.addEventListener('touchend', () => this.handleTouchEnd(), false);
                this.dom.addToPlaylistFromPlayerBtn.addEventListener('click', () => this.handleAddToPlaylistFromPlayer());
            },
            handleAddToPlaylistFromPlayer() {
                if (this.state.currentSongIndex === -1) { this.showToast('Nenhuma música está tocando.', 'info'); return; }
                const currentSong = this.state.songs[this.state.currentSongIndex];
                if (currentSong) { this.state.songIdForOptions = currentSong.id; this.showAddToPlaylistModal(true); }
            },
            setupImageObserver() {
                this.imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) { img.src = src; img.removeAttribute('data-src'); }
                            observer.unobserve(img);
                        }
                    });
                }, { rootMargin: "100px" });
            },
            setupMediaSession() { if ('mediaSession' in navigator) { navigator.mediaSession.setActionHandler('play', () => this.play()); navigator.mediaSession.setActionHandler('pause', () => this.pause()); navigator.mediaSession.setActionHandler('nexttrack', () => this.changeTrack('next')); navigator.mediaSession.setActionHandler('previoustrack', () => this.changeTrack('prev')); } },
            handleTouchStart(event) { if (event.target.closest('button, input[type="range"], .progress-container, .modal-content')) { this.state.touchStartX = 0; return; } this.state.touchStartX = event.changedTouches[0].screenX; },
            handleTouchMove(event) { this.state.touchEndX = event.changedTouches[0].screenX; },
            handleTouchEnd() {
                if (this.state.touchStartX === 0 || this.state.touchEndX === 0) return;
                const swipeDistance = this.state.touchEndX - this.state.touchStartX;
                if (Math.abs(swipeDistance) > 60) {
                    const activeView = document.querySelector('.view.active');
                    if (!activeView) return;
                    const currentIndex = this.state.viewOrder.indexOf(activeView.id);
                    if (currentIndex === -1) return;
                    const nextIndex = swipeDistance < 0 ? Math.min(currentIndex + 1, this.state.viewOrder.length - 1) : Math.max(currentIndex - 1, 0);
                    if (nextIndex !== currentIndex) this.switchView(this.state.viewOrder[nextIndex]);
                }
                this.state.touchStartX = 0; this.state.touchEndX = 0;
            },
            handleSongListClick(event, songSourceList, isPlaylistContext = false) {
                const songItem = event.target.closest('.song-item');
                if (!songItem) return;
                const songId = parseInt(songItem.dataset.songId);
                if (event.target.closest('.options-btn')) {
                    this.state.songIdForOptions = songId;
                    this.state.isPlaylistContextForOptions = isPlaylistContext;
                    this.showSongOptionsModal(true);
                } else if (event.target.closest('.clickable-area')) {
                    this.state.playQueue = [...songSourceList];
                    const queueIndex = this.state.playQueue.findIndex(s => s.id === songId);
                    const globalIndex = this.state.songs.findIndex(s => s.id === songId);
                    this.loadSong(globalIndex, true, queueIndex);
                    if (isPlaylistContext) this.switchView('player-view');
                }
            },
            async addSongToPlaylist(playlistId) {
                const playlist = this.state.playlists.find(p => p.id === playlistId);
                const songId = this.state.songIdForOptions;
                if (playlist && songId && !playlist.songIds.includes(songId)) {
                    playlist.songIds.push(songId);
                    await this.savePlaylistToDB(playlist);
                    await this.loadPlaylistsFromDB();
                    this.showToast(`Adicionado a "${playlist.name}"`, 'success');
                }
                this.showAddToPlaylistModal(false);
            },
            async removeSongFromPlaylist() {
                const playlist = this.state.playlists.find(p => p.id === this.state.currentPlaylistId);
                const songId = this.state.songIdForOptions;
                const song = this.state.songs.find(s => s.id === songId);
                if (playlist && song) {
                    this.showConfirmationModal(`Remover "${song.title}" da playlist?`, async () => {
                        playlist.songIds = playlist.songIds.filter(id => id !== songId);
                        await this.savePlaylistToDB(playlist);
                        this.showPlaylistDetails(this.state.currentPlaylistId);
                        await this.loadPlaylistsFromDB();
                        this.showToast('Música removida.', 'success');
                    });
                }
            },
            _getAudioCache() { return caches.open(this.CACHE_NAME); },
            _getCacheKey(song) { return song.path || `local-file://${song.id}`; },
            async _addSongToCache(song, blob) { const cache = await this._getAudioCache(); const key = this._getCacheKey(song); await cache.put(key, new Response(blob)); },
            async _addSongToCacheFromPath(song) { const cache = await this._getAudioCache(); const key = this._getCacheKey(song); try { const response = await fetch(key); if (!response.ok) throw new Error(`Status: ${response.status}`); await cache.put(key, response.clone()); return true; } catch (error) { throw error; } },
            async _addSongToCacheWithProgress(song, onProgress) {
                const cache = await this._getAudioCache();
                const key = this._getCacheKey(song);
                try {
                    const response = await fetch(key);
                    if (!response.ok) throw new Error(`Status: ${response.status}`);
                    const total = parseInt(response.headers.get('content-length'), 10);
                    let loaded = 0;
                    const stream = new ReadableStream({
                        async start(controller) {
                            const reader = response.body.getReader();
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                loaded += value.byteLength;
                                if (onProgress && total) onProgress((loaded / total) * 100, loaded, total);
                                controller.enqueue(value);
                            }
                            controller.close();
                        }
                    });
                    await cache.put(key, new Response(stream, { headers: response.headers }));
                    return true;
                } catch (error) { throw error; }
            },
            _formatFileSize(bytes) { if (bytes === 0) return '0 B'; const i = Math.floor(Math.log(bytes) / Math.log(1024)); return `${parseFloat((bytes / Math.pow(1024, i)).toFixed(2))} ${['B', 'KB', 'MB', 'GB'][i]}`; },
            async _removeSongFromCache(song) { const cache = await this._getAudioCache(); await cache.delete(this._getCacheKey(song)); },
            async _getSongFromCache(song) { const cache = await this._getAudioCache(); return await cache.match(this._getCacheKey(song)); },
            async toggleSongOfflineStatus(songIdToToggle = null, showFeedback = true) {
                const songId = songIdToToggle || this.state.songIdForOptions;
                const song = this.state.songs.find(s => s.id === songId);
                if (!song) return;
                const download = async () => {
                    if (!song.path) { if (showFeedback) this.showToast('Música local não pode ser baixada.', 'error'); return false; }
                    let toastElement = null;
                    try {
                        if (showFeedback) toastElement = this.showDownloadToast(song.title, 0);
                        await this._addSongToCacheWithProgress(song, (p, l, t) => { if (toastElement) this.updateDownloadToast(toastElement, p, l, t); });
                        song.isOffline = true;
                        await this.saveSongMetadataToDB(song);
                        if (showFeedback) { this.removeDownloadToast(toastElement); this.showToast('Música offline.', 'success'); }
                        return true;
                    } catch (error) {
                        if (toastElement) this.removeDownloadToast(toastElement);
                        if (showFeedback) this.showToast('Erro ao baixar música.', 'error');
                        song.isOffline = false;
                        await this.saveSongMetadataToDB(song);
                        return false;
                    } finally { this.updateSongItemUI(songId); }
                };
                if (song.isOffline) {
                    const removeAction = async () => {
                        await this._removeSongFromCache(song);
                        song.isOffline = false;
                        await this.saveSongMetadataToDB(song);
                        if (showFeedback) this.showToast('Música removida do offline.', 'info');
                        this.updateSongItemUI(songId);
                    };
                    if (!songIdToToggle) { this.showConfirmationModal(`Remover "${song.title}" do modo offline?`, removeAction); } 
                    else { await removeAction(); }
                } else { await download(); }
            },
            showDownloadToast(songTitle) {
                const toast = document.createElement('div');
                toast.className = 'flex flex-col gap-2 text-white text-sm font-semibold p-3 rounded-lg shadow-2xl bg-zinc-700 toast-in min-w-[280px]';
                toast.dataset.downloadToast = 'true';
                toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-download text-lg"></i><div class="flex-grow min-w-0"><p class="truncate">${songTitle}</p><p class="text-xs text-zinc-400 mt-1"><span class="download-progress">0%</span> • <span class="download-size">0 B / 0 B</span></p></div></div><div class="w-full bg-zinc-600 rounded-full h-1.5 overflow-hidden"><div class="download-bar bg-green-500 h-1.5" style="width: 0%"></div></div>`;
                this.dom.toastContainer.appendChild(toast);
                return toast;
            },
            updateDownloadToast(toast, progress, loaded, total) {
                if (!toast) return;
                const progressText = toast.querySelector('.download-progress');
                const sizeText = toast.querySelector('.download-size');
                const progressBar = toast.querySelector('.download-bar');
                if (progressText) progressText.textContent = `${Math.round(progress)}%`;
                if (sizeText && total) sizeText.textContent = `${this._formatFileSize(loaded)} / ${this._formatFileSize(total)}`;
                if (progressBar) progressBar.style.width = `${progress}%`;
            },
            removeDownloadToast(toast) { if (!toast) return; toast.classList.replace('toast-in', 'toast-out'); setTimeout(() => toast.remove(), 400); },
            updateSongItemUI(songId) {
                const song = this.state.songs.find(s => s.id === songId);
                if (!song) return;
                document.querySelectorAll(`.song-item[data-song-id="${songId}"]`).forEach(item => item.querySelector('.offline-indicator')?.classList.toggle('hidden', !song.isOffline));
                if (this.state.songIdForOptions === songId && !this.dom.songOptionsModal.classList.contains('pointer-events-none')) {
                    this.dom.optionsDownloadBtn.textContent = song.isOffline ? "Remover do offline" : "Baixar";
                    this.dom.optionsDownloadBtn.classList.toggle("text-red-500", song.isOffline);
                }
            },
            playPlaylist(shuffle = false) {
                const playlist = this.state.playlists.find(p => p.id === this.state.currentPlaylistId);
                if (!playlist || playlist.songIds.length === 0) return;
                let songsInPlaylist = playlist.songIds.map(id => this.state.songs.find(s => s.id === id)).filter(Boolean);
                this.state.isShuffle = shuffle;
                this.updateShuffleButtonUI();
                if (shuffle) songsInPlaylist.sort(() => Math.random() - 0.5);
                this.state.playQueue = songsInPlaylist;
                const firstSong = this.state.playQueue[0];
                const globalIndex = this.state.songs.findIndex(s => s.id === firstSong.id);
                this.loadSong(globalIndex, true, 0);
                this.switchView('player-view');
            },
            async syncWithServerFolder() {
                const syncIcon = this.dom.syncBtn.querySelector('i');
                syncIcon.classList.add('fa-spin');
                this.dom.syncBtn.disabled = true;
                try {
                    const response = await fetch('./musics-manifest.json');
                    if (!response.ok) throw new Error(`Manifesto: ${response.statusText}`);
                    const serverSongPaths = await response.json();
                    const existingPaths = new Set(this.state.songs.map(s => s.path));
                    const serverPathsSet = new Set(serverSongPaths);
                    const newPaths = serverSongPaths.filter(p => !existingPaths.has(p));
                    const pathsToRemove = this.state.songs.filter(s => s.path && !serverPathsSet.has(s.path));
                    if (newPaths.length > 0 || pathsToRemove.length > 0) {
                        await Promise.all([
                            ...newPaths.map(async path => this.saveSongMetadataToDB({ ...(await this.readRemoteAudioMetadata(path)), path, isOffline: false })),
                            ...pathsToRemove.map(song => this.deleteSongFromDB(song.id))
                        ]);
                        this.showToast('Catálogo sincronizado!', 'success');
                        await this.loadSongsFromDB();
                        await this.loadPlaylistsFromDB();
                    } else {
                        this.showToast('Catálogo já está atualizado.', 'info');
                    }
                } catch (error) { this.showToast('Erro ao sincronizar.', 'error'); } 
                finally { syncIcon.classList.remove('fa-spin'); this.dom.syncBtn.disabled = false; }
            },
            
            // **** CORREÇÃO FINAL APLICADA AQUI ****
            switchView(viewId) {
                const activeView = document.querySelector('.view.active');
                if (activeView && activeView.id === 'playlist-details-view') {
                    const scrollerId = 'playlist-song-list';
                    const instance = VirtualScroller.get(scrollerId);
                    if (instance) {
                        VirtualScroller.destroy(scrollerId); // Chama destroy(), remove do Map
                        this.virtualScrollers[scrollerId] = null; // Anula referência local
                    }
                }
                this.dom.views.forEach(v => v.classList.toggle("active", v.id === viewId));
                this.dom.navButtons.forEach(b => {
                    if (b.dataset.view) {
                        b.classList.toggle("text-green-500", b.dataset.view === viewId);
                        b.classList.toggle("text-zinc-400", b.dataset.view !== viewId);
                    }
                });
            },
            
            async loadSong(index, autoPlay = false, queueIndex = -1) {
                if (index < 0 || index >= this.state.songs.length) return;
                if (this.state.currentObjectUrl) URL.revokeObjectURL(this.state.currentObjectUrl);
                this.state.currentSongIndex = index;
                const song = this.state.songs[index];
                this.state.currentQueueIndex = queueIndex;
                try {
                    let audioSrc = song.path;
                    if (song.isOffline) {
                        const response = await this._getSongFromCache(song);
                        if (response) {
                            const blob = await response.blob();
                            this.state.currentObjectUrl = URL.createObjectURL(blob);
                            audioSrc = this.state.currentObjectUrl;
                        } else console.warn("Cache offline não encontrado para:", song.title);
                    }
                    this.audio.src = audioSrc;
                } catch (e) { console.error("Erro ao carregar áudio:", e); return; }
                this.updatePlayerUI(song);
                this.updatePlayingSongUI(song.id);
                if ("mediaSession" in navigator) {
                    if (navigator.mediaSession.metadata?.artwork[0]?.src.startsWith("blob:")) URL.revokeObjectURL(navigator.mediaSession.metadata.artwork[0].src);
                    const artworkBlob = song.artworkBlob || song.coverBlob;
                    const artworkUrl = artworkBlob ? URL.createObjectURL(artworkBlob) : "";
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title || "Título", artist: song.artist || "Artista", album: song.album || "Spobrefy",
                        artwork: artworkUrl ? [{ src: artworkUrl, sizes: "512x512", type: artworkBlob.type }] : []
                    });
                }
                if (autoPlay) this.play();
            },
            play(){if(this.state.songs.length===0)return;this.state.isPlaying=!0;this.audio.play().catch(e=>console.error("Erro Play:",e));this.dom.playPauseBtn.innerHTML='<i class="fas fa-pause text-3xl"></i>';if("mediaSession"in navigator)navigator.mediaSession.playbackState="playing"},
            pause(){this.state.isPlaying=!1;this.audio.pause();this.dom.playPauseBtn.innerHTML='<i class="fas fa-play text-3xl ml-1"></i>';if("mediaSession"in navigator)navigator.mediaSession.playbackState="paused"},
            togglePlayPause(){if(this.state.currentSongIndex===-1&&this.state.songs.length>0){this.state.playQueue=[...this.state.songs];this.loadSong(0,!0,0)}else{this.state.isPlaying?this.pause():this.play()}},
            changeTrack(direction){const queue=this.state.playQueue.length>0?this.state.playQueue:this.state.songs;if(queue.length===0)return;let nextIndex;const currentIndex=this.state.currentQueueIndex;if(this.state.isShuffle){do{nextIndex=Math.floor(Math.random()*queue.length)}while(queue.length>1&&nextIndex===currentIndex)}else{nextIndex=direction==="next"?(currentIndex+1)%queue.length:(currentIndex-1+queue.length)%queue.length}const nextSong=queue[nextIndex];const globalIndex=this.state.songs.findIndex(s=>s.id===nextSong.id);this.loadSong(globalIndex,!0,nextIndex)},
            handleSongEnd() { if (this.state.repeatMode === 'one') { this.audio.currentTime = 0; this.play(); return; } const isLast = this.state.playQueue.length > 0 && this.state.currentQueueIndex === this.state.playQueue.length - 1; if (isLast && this.state.repeatMode === 'none' && !this.state.isShuffle) { this.pause(); this.audio.currentTime = 0; } else { this.changeTrack('next'); } },
            handleMetadataLoaded(){const song=this.state.songs[this.state.currentSongIndex];if(song&&!song.duration){song.duration=this.audio.duration;this.saveSongMetadataToDB(song)}this.updateProgress();if(this.state.restoredState&&song?.id===this.state.restoredState.songId){this.audio.currentTime=this.state.restoredState.currentTime;this.updateProgress();this.state.restoredState=null}},
            savePlaybackState(){if(this.state.currentSongIndex===-1)return;const song=this.state.songs[this.state.currentSongIndex];if(song)localStorage.setItem("spobrefyPlaybackState",JSON.stringify({songId:song.id,currentTime:this.audio.currentTime,volume:this.audio.volume}))},
            async loadPlaybackState(){const stateJSON=localStorage.getItem("spobrefyPlaybackState");if(stateJSON)try{const state=JSON.parse(stateJSON);this.audio.volume=state.volume||1;const index=this.state.songs.findIndex(s=>s.id===state.songId);if(index>-1){this.state.restoredState=state;this.loadSong(index,!1);this.switchView("player-view")}}catch(e){localStorage.removeItem("spobrefyPlaybackState")}},
            seek(val){if(this.audio.duration)this.audio.currentTime=val/100*this.audio.duration},
            updatePlayerUI(song) { this.dom.trackTitle.textContent=song.title||"Título"; this.dom.trackArtist.textContent=song.artist||"Artista"; if(this.state.currentPlayerCoverUrl)URL.revokeObjectURL(this.state.currentPlayerCoverUrl); const cover=song.artworkBlob||song.coverBlob; const url=cover?URL.createObjectURL(cover):"https://placehold.co/500x500/101010/1DB954?text=Spobrefy"; this.state.currentPlayerCoverUrl=cover?url:null; this.dom.albumCover.src=url; this.dom.background.style.backgroundImage=`url(${url})`; },
            updateProgress(){const{duration,currentTime}=this.audio;if(duration){const percent=currentTime/duration*100;this.dom.progressBar.value=percent;this.dom.progressBar.style.setProperty("--progress-percent",`${percent}%`);this.dom.durationEl.textContent=this.formatTime(duration)}this.dom.currentTimeEl.textContent=this.formatTime(currentTime);if("mediaSession"in navigator&&duration)navigator.mediaSession.setPositionState({duration,playbackRate:this.audio.playbackRate,position:currentTime})},
            formatTime(s){if(isNaN(s))return"0:00";const m=Math.floor(s/60),sc=Math.floor(s%60);return`${m}:${sc<10?"0":""}${sc}`},
            toggleRepeatMode(){const modes=["none","all","one"];this.state.repeatMode=modes[(modes.indexOf(this.state.repeatMode)+1)%modes.length];this.updateRepeatButtonUI()},
            updateRepeatButtonUI(){this.dom.repeatBtn.classList.remove("text-green-500","repeat-mode-one");if(this.state.repeatMode==="all")this.dom.repeatBtn.classList.add("text-green-500");else if(this.state.repeatMode==="one")this.dom.repeatBtn.classList.add("text-green-500","repeat-mode-one")},
            toggleShuffle(){this.state.isShuffle=!this.state.isShuffle;this.updateShuffleButtonUI()},
            updateShuffleButtonUI(){this.dom.shuffleBtn.classList.toggle("text-green-500",this.state.isShuffle)},
            filterSongList(q){const term=q.toLowerCase().trim();const filtered=term?this.state.songs.filter(s=>s.title.toLowerCase().includes(term)||(s.artist||'').toLowerCase().includes(term)):this.state.songs;const noResults=term&&filtered.length===0;this.dom.libraryEmptyState.classList.toggle('hidden',!noResults);if(noResults){this.dom.libraryEmptyIcon.className='fas fa-search text-5xl mb-4';this.dom.libraryEmptyTitle.textContent='Nenhum resultado';this.dom.libraryEmptyText.textContent='Tente outro termo.'}else{this.dom.libraryEmptyIcon.className='fas fa-music text-5xl mb-4';this.dom.libraryEmptyTitle.textContent='Sua biblioteca está vazia';this.dom.libraryEmptyText.innerHTML='Use <i class="fas fa-folder-plus"></i> para começar.';this.dom.libraryEmptyState.classList.toggle('hidden',this.state.songs.length>0)}VirtualScroller.get('song-list')?.setData(filtered)},
            showToast(msg,type='info',dur=2000){if(this.state.activeToastTimeout)clearTimeout(this.state.activeToastTimeout);document.querySelectorAll('#toast-container>div:not([data-download-toast="true"])').forEach(t=>t.remove());const t=document.createElement('div'),i={s:'fa-check-circle',e:'fa-times-circle',i:'fa-info-circle'},c={s:'bg-green-500',e:'bg-red-500',i:'bg-zinc-700'};t.className=`flex items-center gap-3 text-white text-sm font-semibold p-3 rounded-lg shadow-2xl ${c[type[0]]} toast-in`;t.innerHTML=`<i class="fas ${i[type[0]]} text-lg"></i><span>${msg}</span>`;this.dom.toastContainer.appendChild(t);this.state.activeToastTimeout=setTimeout(()=>{t.classList.replace('toast-in','toast-out');t.addEventListener('animationend',()=>t.remove())},dur)},
            showModal(modal,show,onShow){if(show){modal.classList.remove("opacity-0","pointer-events-none");modal.querySelector(".modal-content").classList.remove("scale-95","translate-y-full","sm:scale-95","sm:translate-y-0");if(onShow)onShow()}else{modal.classList.add("opacity-0");modal.querySelector(".modal-content").classList.add(modal.id.includes('add-to-playlist') ? "translate-y-full" : "scale-95");setTimeout(()=>modal.classList.add("pointer-events-none"),300)}},
            showPlaylistModal(s){this.showModal(this.dom.createPlaylistModal,s,()=>this.dom.playlistNameInput.focus())},
            showAddToPlaylistModal(s){if(s)this.renderPlaylistSelectionList();this.showModal(this.dom.addToPlaylistModal,s)},
            showSongOptionsModal(s){if(s){const t=this.state.songs.find(song=>song.id===this.state.songIdForOptions);if(t){this.dom.optionsModalTitle.textContent=t.title;this.dom.optionsModalArtist.textContent=t.artist||"Artista";this.dom.optionsAddToPlaylistLi.style.display=this.state.isPlaylistContextForOptions?"none":"block";this.dom.optionsRemoveFromPlaylistLi.style.display=this.state.isPlaylistContextForOptions?"block":"none";this.dom.optionsDownloadBtn.textContent=t.isOffline?"Remover offline":"Baixar";this.dom.optionsDownloadBtn.classList.toggle("text-red-500",t.isOffline);this.showModal(this.dom.songOptionsModal,!0)}}else this.showModal(this.dom.songOptionsModal,!1)},
            showConfirmationModal(text,cb,show=!0){if(show){this.state.confirmationCallback=cb;this.dom.confirmationModalText.textContent=text;this.showModal(this.dom.confirmationModal,!0)}else{this.showModal(this.dom.confirmationModal,!1);this.state.confirmationCallback=null}},
            showNotificationModal(msg,show=!0){if(show)this.dom.notificationModalText.textContent=msg;this.showModal(this.dom.notificationModal,show)},
            handlePlaylistFormSubmit(){this.state.playlistIdToEdit?this.renamePlaylist():this.createPlaylist()},
            openCreatePlaylistModal(){this.dom.playlistModalTitle.textContent="Nova playlist";this.dom.confirmPlaylistBtn.textContent="Criar";this.dom.playlistNameInput.value="";this.state.playlistIdToEdit=null;this.showPlaylistModal(!0)},
            openRenamePlaylistModal(id){const p=this.state.playlists.find(p=>p.id===id);if(!p)return;this.dom.playlistModalTitle.textContent="Renomear";this.dom.confirmPlaylistBtn.textContent="Salvar";this.dom.playlistNameInput.value=p.name;this.state.playlistIdToEdit=id;this.showPlaylistModal(!0)},
            async createPlaylist(){const name=this.dom.playlistNameInput.value.trim();if(!name)return;await this.savePlaylistToDB({name,songIds:[]});this.showToast('Playlist criada!', 'success');this.showPlaylistModal(!1);await this.loadPlaylistsFromDB()},
            async renamePlaylist(){const newName=this.dom.playlistNameInput.value.trim();const id=this.state.playlistIdToEdit;const p=this.state.playlists.find(p=>p.id===id);if(!newName||!p)return;p.name=newName;await this.savePlaylistToDB(p);this.showToast('Playlist renomeada!', 'success');this.showPlaylistModal(!1);await this.loadPlaylistsFromDB();if(this.state.currentPlaylistId===id)this.dom.playlistDetailsTitle.textContent=newName},
            async deletePlaylist(id){const p=this.state.playlists.find(p=>p.id===id);if(!p)return;this.showConfirmationModal(`Excluir a playlist "${p.name}"?`,async()=>{await this.deletePlaylistFromDB(id);this.showToast('Playlist excluída.','info');await this.loadPlaylistsFromDB()})},
            showPlaylistDetails(id){this.state.currentPlaylistId=id;const p=this.state.playlists.find(p=>p.id===id);if(!p)return;this.dom.playlistDetailsTitle.textContent=p.name;const songs=p.songIds.map(id=>this.state.songs.find(s=>s.id===id)).filter(Boolean);const count=songs.length;const duration=songs.reduce((a,s)=>a+(s.duration||0),0);this.dom.playlistDetailsMeta.textContent=`${count} música${count!==1?'s':''}, ${Math.floor(duration/60)} min`;const coverSong=songs.find(s=>s.artworkBlob||s.coverBlob);const cover=coverSong?(coverSong.artworkBlob||coverSong.coverBlob):null;if(cover){this.dom.playlistDetailsCoverImg.src=URL.createObjectURL(cover);this.dom.playlistDetailsCoverImg.classList.remove("hidden");this.dom.playlistDetailsCoverIcon.classList.add("hidden")}else{this.dom.playlistDetailsCoverImg.src="";this.dom.playlistDetailsCoverImg.classList.add("hidden");this.dom.playlistDetailsCoverIcon.classList.remove("hidden")}this.dom.playlistEmptyState.classList.toggle('hidden',count>0);this.dom.playlistSongList.classList.toggle('hidden',count===0);if(count>0)this.renderSongList(songs,this.dom.playlistSongList);this.switchView("playlist-details-view")},
            async downloadPlaylist(){const p=this.state.playlists.find(p=>p.id===this.state.currentPlaylistId);if(!p)return;const songs=p.songIds.map(id=>this.state.songs.find(s=>s.id===id)).filter(s=>s&&!s.isOffline&&s.path);if(songs.length===0){this.showToast('Todas as músicas já estão offline.','info');return}const btn=this.dom.playlistDownloadAllBtn;const icon=btn.innerHTML;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';btn.disabled=!0;this.showToast(`Baixando ${songs.length} música(s)...`,'info');try{await Promise.all(songs.map(s=>this.toggleSongOfflineStatus(s.id,!0)));this.showToast('Download da playlist concluído!','success')}catch(e){this.showToast('Erro ao baixar músicas.','error')}finally{btn.innerHTML=icon;btn.disabled=!1}},
            updatePlayingSongUI(id){document.querySelectorAll('.song-item.playing').forEach(i=>i.classList.remove('playing'));if(id==null)return;document.querySelectorAll(`.song-item[data-song-id="${id}"]`).forEach(i=>i.classList.add('playing'))},
            db:null,
            async initDB(){return new Promise((res,rej)=>{const req=indexedDB.open("SpobrefyDB",4);req.onerror=()=>rej("Erro DB");req.onsuccess=e=>{this.db=e.target.result;res(this.db)};req.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains("songs"))db.createObjectStore("songs",{keyPath:"id",autoIncrement:!0}).createIndex("title","title");if(!db.objectStoreNames.contains("playlists"))db.createObjectStore("playlists",{keyPath:"id",autoIncrement:!0})}})},
            async addMusicFiles(files){this.showToast(`Adicionando ${files.length} músicas...`,'info');try{await Promise.all(Array.from(files).map(async f=>{const meta=await this.readAudioMetadata(f);const id=await this.saveSongMetadataToDB({...meta,path:null,isOffline:!0},!0);await this._addSongToCache({id},f)}));await this.loadSongsFromDB();this.showToast('Músicas adicionadas!','success')}catch(e){this.showToast('Erro ao adicionar músicas.','error')}},
            async readAudioMetadata(file){return new Promise(res=>{jsmediatags.read(file,{onSuccess:async({tags})=>{let c=null,a=null;if(tags.picture){const o=new Blob([new Uint8Array(tags.picture.data)],{type:tags.picture.format});[c,a]=await Promise.all([this.createThumbnail(o,100,100),this.createThumbnail(o,512,512)]).catch(()=>[null,null])}const ad=document.createElement('audio');ad.src=URL.createObjectURL(file);ad.onloadedmetadata=()=>{URL.revokeObjectURL(ad.src);res({title:tags.title||file.name.replace(/\.[^/.]+$/,""),artist:tags.artist,album:tags.album,coverBlob:c,artworkBlob:a,duration:ad.duration})}},onError:()=>res({title:file.name.replace(/\.[^/.]+$/,""),artist:"Desconhecido",duration:0})})})},
            async readRemoteAudioMetadata(e){try{const t=await fetch(e);if(!t.ok)throw'';return await this.readAudioMetadata(await t.blob())}catch(o){return{title:e.split("/").pop().replace(/\.[^/.]+$/,""),artist:"Desconhecido",duration:0}}},
            async saveSongMetadataToDB(e,t=!1){return new Promise((s,o)=>{const r=this.db.transaction(["songs"],"readwrite").objectStore("songs").put(e);r.onsuccess=e=>s(t?e.target.result:void 0);r.onerror=o})},
            async deleteSongFromDB(id){const s=this.state.songs.find(s=>s.id===id);if(s?.isOffline)await this._removeSongFromCache(s);return new Promise((res,rej)=>{const t=this.db.transaction(["songs"],"readwrite");t.objectStore("songs").delete(id);t.oncomplete=res;t.onerror=rej})},
            async loadSongsFromDB(){return new Promise((e,t)=>{const r=this.db.transaction(["songs"],"readonly").objectStore("songs").getAll();r.onsuccess=t=>{this.state.songs=t.target.result.sort((a,b)=>a.title.localeCompare(b.title));this.renderSongList();this.updatePlayingSongUI(this.state.songs[this.state.currentSongIndex]?.id);e(this.state.songs)};r.onerror=t})},
            async savePlaylistToDB(e){return new Promise((t,s)=>{const r=this.db.transaction(["playlists"],"readwrite").objectStore("playlists").put(e);r.onsuccess=t;r.onerror=s})},
            async loadPlaylistsFromDB(){return new Promise((e,t)=>{const r=this.db.transaction(["playlists"],"readonly").objectStore("playlists").getAll();r.onsuccess=t=>{this.state.playlists=t.target.result.sort((a,b)=>a.name.localeCompare(b.name));this.renderPlaylistGrid();e(this.state.playlists)};r.onerror=t})},
            async deletePlaylistFromDB(e){return new Promise((t,s)=>{const r=this.db.transaction(["playlists"],"readwrite").objectStore("playlists").delete(e);r.onsuccess=t;r.onerror=s})},
            cleanupObjectURLs(e){e.querySelectorAll("img[src^='blob:']").forEach(i=>URL.revokeObjectURL(i.src))},
            cleanupItemURLs(e){e.querySelectorAll("img[src^='blob:']").forEach(i=>URL.revokeObjectURL(i.src))},
            renderSongList(songs=this.state.songs,container=this.dom.songList){const id=container.id;if(container===this.dom.songList)this.dom.libraryEmptyState.classList.toggle('hidden',this.state.songs.length>0);if(songs.length===0){if(this.virtualScrollers[id]){VirtualScroller.destroy(id);this.virtualScrollers[id]=null}container.innerHTML='';return}const scroller=VirtualScroller.get(id);if(scroller)scroller.setData(songs);else{this.virtualScrollers[id]=VirtualScroller.create(id,{itemHeight:68,buffer:10,data:songs,renderItem:s=>{const t=this.dom.songItemTemplate.content.cloneNode(!0),i=t.querySelector('.song-item');i.dataset.songId=s.id;if(s.coverBlob)i.querySelector('.song-cover').src=URL.createObjectURL(s.coverBlob);i.querySelector('.song-title').textContent=s.title;i.querySelector('.song-artist').textContent=s.artist||'Desconhecido';i.querySelector('.offline-indicator').classList.toggle('hidden',!s.isOffline);if(s.id===this.state.songs[this.state.currentSongIndex]?.id)i.classList.add('playing');const w=document.createElement('div');w.appendChild(t);return w.firstElementChild}})}this.updatePlayingSongUI(this.state.songs[this.state.currentSongIndex]?.id)},
            renderPlaylistGrid(){this.cleanupObjectURLs(this.dom.playlistGrid);this.dom.playlistGrid.innerHTML="";const f=document.createDocumentFragment();this.state.playlists.forEach(p=>{const t=this.dom.playlistItemTemplate.content.cloneNode(!0),e=t.querySelector(".playlist-item-grid-entry"),i=t.querySelector(".playlist-cover");e.dataset.id=p.id;t.querySelector(".playlist-name").textContent=p.name;t.querySelector(".playlist-song-count").textContent=`${p.songIds.length} música${p.songIds.length!==1?"s":""}`;const s=p.songIds.length>0?this.state.songs.find(s=>s.id===p.songIds[0]):null;if(s?.coverBlob)i.src=URL.createObjectURL(s.coverBlob);f.appendChild(t)});this.dom.playlistGrid.appendChild(f)},
            renderPlaylistSelectionList(){this.dom.playlistSelectionList.innerHTML="";const id=this.state.songIdForOptions;if(this.state.playlists.length===0){this.dom.playlistSelectionList.innerHTML='<p class="text-zinc-400 text-center p-4">Nenhuma playlist.</p>';return}const f=document.createDocumentFragment();this.state.playlists.forEach(p=>{const b=document.createElement('button'),isIn=p.songIds.includes(id);b.className=`w-full flex items-center justify-between p-4 hover:bg-zinc-700 rounded-lg text-left ${isIn?'opacity-60 cursor-not-allowed':''}`;b.dataset.playlistId=p.id;b.disabled=isIn;b.innerHTML=`<span>${p.name}</span>`+(isIn?'<i class="fas fa-check text-green-500"></i>':'');f.appendChild(b)});this.dom.playlistSelectionList.appendChild(f)}
        };
        App.init();
    });
</script>

</body>
</html>
